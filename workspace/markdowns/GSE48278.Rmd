---
title: "test"
output:
  html_document: default
  pdf_document: default
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(echo = TRUE, eval=FALSE)

```

# llll

```{r import, echo=FALSE}
library(illuminaHumanv4.db)
library(ggpubr)
library(GEOquery)
library(limma)
library(gplots)
library(dplyr)
library(tidyr)



```

## Importing the Data

```{r getting_experiment,  echo=FALSE}
my_id <- "GSE48278"
gse <- getGEO(my_id, GSEMatrix =TRUE)
```

Getting the samples from platform GPL570 from the experiment (in the bioproject)
```{r get_samples, echo=FALSE}
if (length(gse) > 1) idx <- grep("GPL570", attr(gse, "names")) else idx <- 1
gset1 <- gse[[idx]]


gset = gset1

```


Seeing the metadata
```{r metadata}
pData(gset)
fData(gset)
fvarLabels(gset)
```
Seeing the headers of the metadata
```{r headers}
sample_data = pData(gset)
colnames(sample_data)

```

Here we need to manually select the column with the class that we are interesting and see the values
here the data seems to be in source_name_ch1

```{r see_unique_categories}
unique(sample_data$characteristics_ch1.2)
```

I want to have the diabetic men marked 
```{r clean_up}
sample_data$age <- sample_data$`age (yr):ch1`
sample_data 
```


```{r }
ex <- exprs(gset) # expression data, what form is this?
qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm=T))
LogC <- (qx[5] > 100) ||
  (qx[6]-qx[1] > 50 && qx[2] > 0)
if (LogC) { ex[which(ex <= 0)] <- NaN
exprs(gset) <- log2(ex) } # i think this code is trying to determine whether the data is in log2 format yet
```

## Design matrix

Now we are setting the theshold for the diferentially expressed genes
```{r}
PVALUE = 0.1
LOGFOLDCHANGE = 1
y = "Young"
o = "Old"
m = "MiddleAge"

EXPECTED_PROPORTION = 0.01

metadata_doc_name <- paste("samples_", my_id, ".csv", sep = "")
expression_doc_name <- paste("expression_", my_id, ".csv", sep = "")

assign_names <- function(c1, c2) {
  doc_name <- paste("DEG_list_", my_id, "_", c1, "_vs_", c2, ".csv", sep = "")
  dds_doc_name <- paste("dds_", my_id, "_", c1[1], c2[1], ".csv", sep = "")
  
  return (c(doc_name, dds_doc_name))
}

```

And let's save the expression and metadata files that are independent of the comparisons.
```{r saving_tables_1}
gene_table = featureData(gset)
symbol_column  <- gene_table$GB_ACC
symbol_df <- data.frame(GB_ACC = symbol_column)
desired_columns <- c("GB_ACC", "SEQUENCE", "ENTREZ_GENE_ID", "RefSeq.Transcript.ID","REFSEQ", "Gene.Symbol", "Ensembl_ID", "SPOT_ID")

# Loop through each desired column
for (col_name in desired_columns) {
  # Check if the column exists in gene_table
  if (col_name %in% colnames(gene_table)) {
    symbol_column  <- gene_table[[col_name]]
    symbol_df[[col_name]] <- symbol_column
  } 
}
# Combine the extracted "symbol" column with the row index from the AnnotatedDataFrame
ID_geneSymbol_df <- cbind(symbol_df, row.names = rownames(gene_table))



expression_df = merge(ex, ID_geneSymbol_df, by="row.names", all.x=TRUE)
write.table(expression_df, expression_doc_name, row.names=F, sep=",")

write.table(sample_data, metadata_doc_name, row.names=F, sep=",")

```
